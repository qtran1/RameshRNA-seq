---
output: pdf_document
---
Barplot Analysis of Cushing Results
=======================================

This script produces bar plots. And it was last run on `r date()`.

```{r file-input, echo=FALSE, warning=FALSE}
filename <- "../data/processed/rpkm_table.csv"
liver.filename <- "../data/processed/Liver_Interaction_DESeqResultsProteinCodingOnly.csv"
wat.filename <- "../data/processed/WAT_Interaction_DESeqResultsProteinCodingOnly.csv"
#read in the file
normalized.data <- read.csv(filename, row.names='X')
liver.data <- read.csv(liver.filename, row.names='X')
wat.data <- read.csv(wat.filename, row.names='X')
mapping <- read.csv("../data/raw/Sample_mapping.csv")

#Making Normal and Vehicle as reference groups
mapping$Diet <- relevel(mapping$Diet, ref="Normal")
mapping$Drug <- ifelse(mapping$Treatment=="vehicle", "Vehicle", "GTX")
mapping$Drug <- as.factor(mapping$Drug)
mapping$Diet <- relevel(mapping$Drug, ref="Vehicle")

#replace the .txt in column names to empty space
colnames(normalized.data) <- gsub(pattern = ".txt", replacement = "", x = colnames(normalized.data), fixed = TRUE)

#Making Liver and WAT rpkm data sets
mapping.liver <- mapping[mapping$Tissue=="Liver",]
mapping.wat <- mapping[mapping$Tissue=="WAT",]

normalized.liver <- normalized.data[,colnames(normalized.data) %in% mapping.liver$Sample]
normalized.wat <- normalized.data[,colnames(normalized.data) %in% mapping.wat$Sample]

#get gene names for transcripts
library(biomaRt)
mart = useMart("ENSEMBL_MART_ENSEMBL", host="dec2014.archive.ensembl.org")
ensembl = useDataset('mmusculus_gene_ensembl',mart=mart)
gene.data <- getBM(attributes=c('ensembl_gene_id', 'external_gene_name'), 
                    filters = 'ensembl_gene_id',
                    values = rownames(normalized.data), mart = ensembl)
rpkm.data <- merge(normalized.data, gene.data, by.x='row.names', by.y='ensembl_gene_id') 
rpkm.data.unique <- rpkm.data[!duplicated(rpkm.data$external_gene_name),]
rownames(rpkm.data.unique) <- rpkm.data.unique$external_gene_name
rpkm.data.unique <- rpkm.data.unique[,-1]

rpkm.liver <- rpkm.data.unique[,colnames(rpkm.data.unique) %in% mapping.liver$Sample]
rpkm.liver$external_gene_name <- rpkm.data.unique$external_gene_name
rpkm.wat <- rpkm.data.unique[,colnames(rpkm.data.unique) %in% mapping.wat$Sample]
rpkm.wat$external_gene_name <- rpkm.data.unique$external_gene_name

#put the data in long format
library(reshape2)  
rpkm.long.liver <- reshape(rpkm.liver, direction="long", varying=list(names(rpkm.liver)[1:9]), v.names="Expression", idvar="external_gene_name", timevar="Diet_Drug", ids=rownames(rpkm.liver), times=c(rep('Normal_Vehicle',3),rep("HFD_Vehicle",3), rep("HFD_GTX",3)))

rpkm.long.wat <- reshape(rpkm.wat, direction="long", varying=list(names(rpkm.wat)[1:9]), v.names="Expression", idvar="external_gene_name", timevar="Diet_Drug", ids=rownames(rpkm.wat), times=c(rep('Normal_Vehicle',3),rep("HFD_Vehicle",3), rep("HFD_GTX",3)))


#calculate standard error
library(plyr)
rpkm.liver.se <- ddply(rpkm.long.liver, .(external_gene_name,Diet_Drug), summarise, se = sd(Expression, na.rm=T)/sqrt(length(Expression)), mean_Expression = mean(Expression, na.rm=T))

rpkm.wat.se <- ddply(rpkm.long.wat, .(external_gene_name,Diet_Drug), summarise, se = sd(Expression, na.rm=T)/sqrt(length(Expression)), mean_Expression = mean(Expression, na.rm=T))

rpkm.liver.se$Diet_Drug <- as.factor(rpkm.liver.se$Diet_Drug)
rpkm.wat.se$Diet_Drug <- as.factor(rpkm.wat.se$Diet_Drug)

rpkm.liver.se <- rpkm.liver.se[order(rpkm.liver.se$external_gene_name, rpkm.liver.se$Diet_Drug, decreasing=T),]
rpkm.wat.se <- rpkm.wat.se[order(rpkm.wat.se$external_gene_name, rpkm.wat.se$Diet_Drug, decreasing=T),]

```


```{r grouped-plots, dev=c('png','pdf'), echo=FALSE, fig.show='asis' }
library(ggplot2)
adipocytes <- c("Nrg4", "Ucp1", "Tmem120b", "Adrb3","Aqp7", "Gpr81", "Slc27a1", "Slc7a10", "Epsti1", "Cited1", "Fabp4")
brown_fat <- c("Ucp1", "Gpr119", "Tspan18", "P2rx5", "Zic1", "Lhx8", "Pat2", "Ebf3", "Prdm16", "Ppargc1a" )
white_fat <- c("Slc7a10", "Tmem26", "Shox2", "Hoxc8","Hoxc9", "Adpioq", "Fbxo31", "Mpzl2", "Mir206", "Mir133b")
beige_fat <- c("Tbx1", "Tmem26", "Tnfrsf9", "Irx3", "Irx5")
hormones <- c('Lepr')
cortisol_signaling <-  c("Hsd11b2","Nr3c1","Nr3c2")
hsd11b1 <- "Hsd11b1"
lipolysis <- c("Abhd5", "Acvr1c", "Pnpla1")
lipid_metabolism <- c('Dhcr24','Tfcp2l1','Pnpla3','Dhcr7','Pcyt2','Cyp7b1','Hpgd','Plce1','Idi1','Npc1l1','Pdss2')
unsat_FA <- c("Elovl5", "Elovl6", "Fads1", "Fads2", "Hsd17b12", "Acox1", "Hadha", "Pecr")
adipocyte_regulator <- "Ube2i"

wnt <- c("Wnt1", "Wnt10b", "Wnt3a", "Wnt5a", "Wnt5b")
ppar_genes <- c("Ppara","Ppard","Pparg","Ppargc1a","Ppargc1b", "Fabp1", "Fas", "Apt1", "Cept1", "Tnf", "Il6", "Pck1", "Pck2", "Hadha")
adipocyte1 <- c("Acacb","Adrb2","Angpt2","Axin1","Bmp2","Bmp4", "Bmp7","Ccnd1", "Cdk4","Cdkn1a", "Cdkn1b", "Cebpb","Cfd", "Creb1","Ddit3","Dio2","Dkk1")
adipocyte2 <- c("E2f1","Egr2","Fabp4","Fasn","Fgf1","Fgf10","Fgf2","Foxc2","Foxo1","Gata2","Gata3","Hes1","Insr","Irs1","Irs2","Jun","Klf15","Klf2","Klf4","Lepr","Lmna","Lrp5", "Mapk14", "Ncoa2","Ncor2","Nr0b2")
adipocyte3 <- c("Hsdd11b1","Nr1h3","Nrf1", "Rb1","Runx1t1","Rxra","Sfrp1","Sirt1","Sirt2","Sirt3","Slc2a4","Src","Srebf1","Taz","Tcf7l2","Tsc22d3","Twist1", "Vdr")

genes_exp_more100 <- c( "Agt", "Cebpa","Agpat2", 'Fads1','Fads2')
genes_exp_less100 <- c("Fasn", "Pck", "Dgat2",  "Mgll", "Pnpla2")
genes_exp_less40 <- c("Lep", "Adipoq", "Fabp4", "Lpl", "Lipe", "Cfd", 'Adrb3', "Fzd4", 'Cd300lg', "Retn", "Sfrp5", "Adig")
genes_exp_1000 <- c("Scd1")
  
gene.data.name <- c('cortisol_signaling', 'adipocytes', 'brown_fat', 'white_fat', 'beige_fat', 'lipolysis', 'lipid_metabolism', 'unsat_FA', 'adipocyte_regulator', 'wnt', 'ppar_genes', 'adipocyte1', 'adipocyte2', 'adipocyte3', 'hormones', 'genes_exp_less100', 'genes_exp_more100', 'genes_exp_less40', 'genes_exp_1000')
for (name in gene.data.name){
  #name <- as.name(name) #convert string to variable name
  gene.data <- rpkm.liver.se[rpkm.liver.se$external_gene_name%in%eval(as.name(name)),]
  gene.data$external_gene_name <- factor(gene.data$external_gene_name, levels=eval(as.name(name)))
  
  ggplot(gene.data, aes(x=external_gene_name, y=mean_Expression, fill=Diet_Drug))+ 
    #this line together with show_guide=F and the element_rect=black get rid of the slash in legend box
    geom_bar(stat="identity", width=.8, position=position_dodge(width=.8)) +
    geom_bar(stat="identity",width=.8, position=position_dodge(width=.8), col="black", show_guide=F) +
    geom_errorbar(position=position_dodge(width=.8), aes(ymin=mean_Expression-se, ymax=mean_Expression+se), width=.2)+
    theme_bw()+theme(axis.text.x=element_text(angle=90))+xlab("")+ ylab("mRNA Expression (RPKM)") +
    theme(panel.grid.minor = element_blank()) + theme(panel.grid.major = element_blank()) + 
    theme(panel.border=element_blank())+ 
    theme(axis.line = element_line(color = 'black')) +
    scale_fill_grey(start = 0.3, end = .9, guide=guide_legend()) +
    #guides(fill = guide_legend(keywidth = .5, keyheight = .5)) +
    theme(text = element_text(size=20), axis.text.x = element_text(angle=70,hjust=.5,vjust=.5)) +
    theme(legend.position=c(.75,.90), legend.title=element_blank(), legend.key=element_rect(color="black"))   + ggtitle(name)
    
  ggsave(filename=paste('figures/Liver-', name, '-barplot.pdf',sep=""))
}


###Bar plots for WAT####
for (name in gene.data.name){
  #name <- as.name(name) #convert string to variable name
  gene.data <- rpkm.wat.se[rpkm.wat.se$external_gene_name%in%eval(as.name(name)),]
  gene.data$external_gene_name <- factor(gene.data$external_gene_name, levels=eval(as.name(name)))
  
  ggplot(gene.data, aes(x=external_gene_name, y=mean_Expression, fill=Diet_Drug))+ 
    #this line together with show_guide=F and the element_rect=black get rid of the slash in legend box
    geom_bar(stat="identity", width=.8, position=position_dodge(width=.8)) +
    geom_bar(stat="identity",width=.8, position=position_dodge(width=.8), col="black", show_guide=F) +
    geom_errorbar(position=position_dodge(width=.8), aes(ymin=mean_Expression-se, ymax=mean_Expression+se), width=.2)+
    theme_bw()+theme(axis.text.x=element_text(angle=90))+xlab("")+ ylab("mRNA Expression (RPKM)") +
    theme(panel.grid.minor = element_blank()) + theme(panel.grid.major = element_blank()) + 
    theme(panel.border=element_blank())+ 
    theme(axis.line = element_line(color = 'black')) +
    scale_fill_grey(start = 0.3, end = .9, guide=guide_legend()) +
    #guides(fill = guide_legend(keywidth = .5, keyheight = .5)) +
    theme(text = element_text(size=20), axis.text.x = element_text(angle=70,hjust=.5,vjust=.5)) +
    theme(legend.position=c(.75,.90), legend.title=element_blank(), legend.key=element_rect(color="black"))   + ggtitle(name)
    
  ggsave(filename=paste('figures/WAT-', name, '-barplot.pdf',sep=""))
}
```


The data used is in the file **`r filename`**.  This file was most recently processed on ```r date()```.


Session Information
---------------------

```{r session-information}
sessionInfo()
```
